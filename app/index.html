<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Mobile Air Box</title>
    
    <!--jquery-->  
    <script src="./js/jquery-3.2.1.min.js"></script>
    <!--semantic-->  
    <link rel="stylesheet" href="./css/semantic.min.css">
    <script src="./js/semantic.min.js"></script>
    <!--chart-->
    <script src="./js/dygraph.min.js"></script>
    <link rel="stylesheet" src="./css/dygraph.min.css" />
    <!--leaflet-->
    <link rel="stylesheet" href="./css/leaflet.css" />
    <script src="/js/leaflet.js"></script>
    <!--mapbox-->
    <script src='./js/mapbox-gl.js'></script>
    <link href='./css/mapbox-gl.css' rel='stylesheet' />
    
    
    <!--customer style-->
    <link rel="stylesheet" href="./css/index.css">
    
    
</head>
<body style="background: papayawhip;">
    <div class="ui segment" style="margin-top: 10px;">
        <h2 id="mab" class="ui center aligned icon header" style="color:cornflowerblue;">
            <i class="circular users icon"></i>
            Mobile Air Box
        </h2>
        <form class="ui form">
            <h4 id="a_clk" class="ui dividing header">
                <i class="caret down icon" style="color:chocolate;"></i>
                <div class="content" style="color:chocolate;">
                Port Information
                </div>
            </h4>
            <div id="a_hid">
                <div class="four fields">
                    <div class="field">
                        <label style="color:slategray;">Arduino Port</label>
                        <input type="text" id="ap" maxlength="16" value="">
                    </div>
                    <div class="field">
                        <label style="color:slategray;">Arduino Baud</label>
                        <input type="text" id="ab" maxlength="16" value="">
                    </div>
                    <div class="field">
                        <label style="color:slategray;">GPS Port</label>
                        <input type="text" id="gp" maxlength="16" value="">
                    </div>
                    <div class="field">
                        <label style="color:slategray;">GPS Baud</label>
                        <input type="text" id="gb" maxlength="16" value="">
                    </div>
                </div>
                <div class="four fields">
                    <div class="field">
                        <label style="color:slategray;">Server IP</label>
                        <input type="text" id="sp" maxlength="32" value="">
                    </div>
                </div>
            </div>
            <h4 id="b_clk" class="ui dividing header">
                <i class="caret down icon" style="color:chocolate;"></i>
                <div class="content" style="color:chocolate;">
                Device Information
                </div>
            </h4>
            <div id="b_hid">
                <div class="four fields">
                    <div class="field">
                        <label style="color:slategray;">Device</label>
                        <input type="text" id="dev" maxlength="16" value="">
                    </div>
                    <div class="field">
                        <label style="color:slategray;">Device id</label>
                        <input type="text" id="devid" maxlength="16" value="">
                    </div>
                    <div class="field">
                        <label style="color:slategray;">SiteName</label>
                        <input type="text" id="site" maxlength="16" value="">
                    </div>
                    <div class="field">
                        <label style="color:slategray;">App</label>
                        <input type="text" id="app" maxlength="16" value="">
                    </div>
                </div>
                <div class="fields">
                    <div class="four wide field">
                        <label style="color:slategray;">Test_lat</label>
                        <input type="text" id="tlat" maxlength="16" value="">
                    </div>
                    <div class="four wide field">
                        <label style="color:slategray;">Test_lon</label>
                        <input type="text" id="tlon" maxlength="16" value="">
                    </div>
                    <div class="four wide field">                        
                        <label>&nbsp</label>
                        <div id="c_clk">
                            <div class="ui left icon input">
                                <input type="text" id="tlon" maxlength="32" value="Set Location" style="border: 1px; color: mediumseagreen;" readonly="readonly">
                                <i class="caret down icon" style="color: mediumseagreen;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div id="b_hid2">
            <div id="c_hid">
                <div class="fields">
                    <div class="sixteen wide field">
                        <div id="map" style="height: 220px; width:100%;"></div> 
                    </div> 
                </div>
            </div>
            <div class="fields" style="margin-top: 10px;">
                <div class="sixteen wide field" style="text-align: center;">
                    <button class="ui button" id="ld" style="background: lightblue;">load</button>
                    <button class="ui button" id="sv" style="background: lightpink;">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="ui segment">
        <form class="ui form">
            <h4 id="d_clk" class="ui dividing header">
                <i class="caret down icon" style="color:chocolate;"></i>
                <div class="content" style="color:chocolate;">
                GPS State
                </div>
            </h4>
            <div id="d_hid">
                <div class="three fields">
                    <div class="field">
                        <label style="color:slategray;">Satellites</label>
                        <input type="text" id="sate" maxlength="16" value="" style="border: 1px;" readonly="readonly">
                    </div>
                    <div class="field">
                        <label style="color:slategray;">Latitude</label>
                        <input type="text" id="lat" maxlength="16" value="" style="border: 1px;" readonly="readonly">
                    </div>
                    <div class="field">
                        <label style="color:slategray;">Longitude</label>
                        <input type="text" id="lon" maxlength="16" value="" style="border: 1px;" readonly="readonly">
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <div class="ui segment" style="padding-bottom: 20px;">
        <div class="ui one column grid">
            <div class="row">
                <div class="column">
                    <h4 class="ui horizontal divider header"><i class="bar chart icon" style="color:gold;"></i>Temperature&deg;C</h4>
                </div>
            </div>
            <div class="row">
                <div class="column">
                    <div class="ui grid">
                        <div id="chart1" style="height: 220px; width:85%;"></div>
                        <div id="m1" style="text-align: right;background-color: rgba(255,255,255,0.8);margin-top:0%;margin-left:85%;position:absolute;z-index:20;width:100px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="ui segment" style="padding-bottom: 20px;">
        <div class="ui one column grid">
            <div class="row">
                <div class="column">
                    <h4 class="ui horizontal divider header"><i class="bar chart icon" style="color:gold;"></i>Humidity%</h4>
                </div>
            </div>
            <div class="row">
                <div class="column">
                    <div class="ui grid">
                        <div id="chart2" style="height: 220px; width:85%;"></div>
                        <div id="m2" style="text-align: right;background-color: rgba(255,255,255,0.8);margin-top:0%;margin-left:85%;position:absolute;z-index:20;width:100px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="ui segment" style="padding-bottom: 20px;">
        <div class="ui one column grid">
            <div class="row">
                <div class="column">
                    <h4 class="ui horizontal divider header"><i class="bar chart icon" style="color:gold;"></i>Pm1/2.5/10 μg/m3</h4>
                </div>
            </div>
            <div class="row">
                <div class="column">
                    <div class="ui grid">                
                        <div id="chart3" style="height: 220px; width:85%;"></div>
                        <div id="m3" style="text-align: right;background-color: rgba(255,255,255,0.8);margin-top:0%;margin-left:85%;position:absolute;z-index:20;width:100px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--
    <div class="ui segment">
        <div class="ui one column grid">
            <div class="row">
                <div class="column">
                    <h4 class="ui horizontal divider header"><i class="bar chart icon"></i>Pm2.5 μg/m3</h4>
                </div>
            </div>
            <div class="row">
                <div class="column">
                    <div id="chart4" style="height: 220px; width:100%;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="ui segment">
        <div class="ui one column grid">
            <div class="row">
                <div class="column">
                    <h4 class="ui horizontal divider header"><i class="bar chart icon"></i>Pm10 μg/m3</h4>
                </div>
            </div>
            <div class="row">
                <div class="column">
                    <div id="chart5" style="height: 220px; width:100%;"></div>
                </div>
            </div>
        </div>
    </div>-->
</body>

<script>
var MbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
'Imagery © <a href="http://mapbox.com">Mapbox</a>';

var MbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png32?access_token=pk.eyJ1IjoidTk5MjMwMDEiLCJhIjoiY2o3YWdqeGZoMGZhZDJxbzFtZ2wxMWswZiJ9.rieTxvxJSPfaerXHPjMIiA';

var host = location.hostname;
var port = location.port;
var ws = new WebSocket("ws://"+host+":"+port+"/socket"); 
var log1,log2;
var cha1 = [];
var cha2 = [];
var cha3 = [];
var g1,g2,g3;
var chart1 = true;
var chart2 = true;
var chart3 = true;
var plot = true;
var map1 = true;
var Map_L;
const maxBuf =50;
//傳資料
ws.onopen = function(evt) { 
    console.log("ws open");
    ws.send("5,open");
}; 
ws.onclose = function(evt) { 
    console.log("ws close"); 
}; 
ws.onmessage = function(evt) {
    switch(evt.data[0]){
        case "0"://接收設定檔config
            var n = evt.data.length;
            var d = evt.data.slice(2,n-1);
//            var d = evt.data.slice(1,n);
            log1 = d.split(" ");
            upInfo();//更新裝置資料
            //console.log(evt.data);
        break;
        case "1"://接收資料data
            var n = evt.data.length;
//            var d = evt.data.slice(2,n-1);
            var d = evt.data.slice(1,n);
            log2 = d.split(" ");
            upData();//更新資料顯示
            //console.log("Get data");
        break;
        case "5":
            console.log(evt.data);
        break;
    }
}; 
ws.onerror = function(evt) { 
    console.log("error: "+evt.data);
};
//更新設定檔
function upInfo(){
    document.getElementById('ap').value=log1[2]; 
    document.getElementById('ab').value=log1[3]; 
    document.getElementById('gp').value=log1[0]; 
    document.getElementById('gb').value=log1[1]; 
    document.getElementById('dev').value=log1[5];
    document.getElementById('devid').value=log1[7];
    document.getElementById('app').value=log1[6];
    document.getElementById('site').value=log1[8];
    document.getElementById('tlat').value=log1[9];
    document.getElementById('tlon').value=log1[10];
    document.getElementById('sp').value=log1[11];
    
    var loc = [log1[9], log1[10]];
    if(map1){
        //第一次執行建立地圖
        map1 = false;
        var BaseLyr = L.tileLayer(MbUrl, {id: 'mapbox.streets', attribution: MbAttr});
        Map_L = L.map('map', {
            center: loc,
            zoom: 13
        });
        Map_L.addLayer(BaseLyr);
        
        pastMark = L.marker(loc,{draggable: true}).addTo(Map_L)
            .bindPopup('Your location is here!<br>Please drag the marker to set the position!')
            .openPopup()
            .on('dragend', function() {
			var coord = String(pastMark.getLatLng()).split(',');
			var lat = coord[0].split('(');
			var lng1 = coord[1].split(')');
            var lng = lng1[0].split(' ');
            document.getElementById('tlat').value=lat[1];
            document.getElementById('tlon').value=lng[1];
			pastMark.bindPopup("Moved to: " + lat[1] + ", " + lng[1]);
            pastMark.openPopup();
		});
    }else{
        //顯示預設座標
        document.getElementById('tlat').value = loc[0];
        document.getElementById('tlon').value = loc[1];
        pastMark.setLatLng(loc);
        pastMark.bindPopup("Moved to: " + loc[0] + ", " + loc[1]);
        pastMark.openPopup();
    }
}

//更新顯示資料
function upData(){
    var lat = parseFloat(log2[5]);
    var lon = parseFloat(log2[6]);    
    var sat = parseInt(log2[19]);
    var s1 = log2[8].split(".");
    var time = new Date(log2[7]+" "+s1[0]+" "+log2[9]);
    var temp = parseFloat(log2[13]);
    var pm1 = parseFloat(log2[15]);
    var pm25 = parseFloat(log2[16]);
    var pm10 = parseFloat(log2[17]);
    var humd = parseFloat(log2[18]);
    
    document.getElementById('sate').value=sat; 
    document.getElementById('lat').value=lat; 
    document.getElementById('lon').value=lon; 
    
    //更新BUFFER
    cha1.push([time, temp]);
    if(cha1.length>maxBuf){
        cha1.shift();
    }
    cha2.push([time, humd]);
    if(cha2.length>maxBuf){
        cha2.shift();
    }
    cha3.push([time, pm1, pm25, pm10]);
    if(cha3.length>maxBuf){
        cha3.shift();
    }
    
    //更新畫圖
    if(plot){
        plot = false;
        requestAnimationFrame(update)
    }
}
var c1M=[0,0,100,0];//max i min i
var c1M1=[0,0,100,0];//max i min i
var c2M=[0,0,100,0];
var c2M1=[0,0,100,0];
var c3M=[0,0,100,0];
var c3M1=[0,0,100,0];

function inccren(c_M,c_M_,c,n){
    //MAX
    if(c_M[0] > c){
        if(c_M_[0] > c){
        }else{
            c_M_[0] = c;
            c_M_[1] = n;
        }
    }else{
        c_M_[0] = c_M[0];
        c_M_[1] = c_M[1];
        c_M[0] = c;
        c_M[1] = n;
    }
    //MIN
    if(c_M[2] < c){
        if(c_M_[2] < c){
        }else{
            c_M_[2] = c;
            c_M_[3] = n;
        }
    }else{
        c_M_[2] = c_M[2];
        c_M_[3] = c_M[3];
        c_M[2] = c;
        c_M[3] = n;
    }
}

function inccren2(c_M,c_M_,c,n){
    //遺忘
    //2nd
    c_M_[1] = c_M_[1]-1;
    if(c_M_[1] == 0){
        c_M_[0] = 0;
        c_M_[1] = maxBuf;
    }
    c_M_[3] = c_M_[3]-1;
    if(c_M_[3] == 0){
        c_M_[2] = 100;
        c_M_[3] = maxBuf;
    }
    //1st
    c_M[1] = c_M[1]-1;
    if(c_M[1] == 0){
        c_M[0] = c_M_[0];
        c_M[1] = c_M_[1];
    }
    c_M[3] = c_M[3]-1;
    if(c_M[3] == 0){
        c_M[2] = c_M_[2];
        c_M[3] = c_M_[3];
    }
    //MAX
    if(c_M[0] > c){
        if(c_M_[0] > c){
        }else{
            c_M_[0] = c;
            c_M_[1] = n;
        }
    }else{
        c_M_[0] = c_M[0];
        c_M_[1] = c_M[1];
        c_M[0] = c;
        c_M[1] = n;
    }
    //MIN
    if(c_M[2] < c){
        if(c_M_[2] < c){
        }else{
            c_M_[2] = c;
            c_M_[3] = n;
        }
    }else{
        c_M_[2] = c_M[2];
        c_M_[3] = c_M[3];
        c_M[2] = c;
        c_M[3] = n;
    }
}

var update = function() {

        var n = cha1.length-1;
        var c1 = cha1[n][1];
        var c2 = cha2[n][1];
        var c3 = cha3[n][1];
        var c4 = cha3[n][2];
        var c5 = cha3[n][3];
        var c3max,c3min;
        c3max = c3>c4 ? c3:c4;
        c3max = c3max>c5 ? c3max:c5;
        c3min = c3<c4 ? c3:c4;
        c3min = c3min<c5 ? c3min:c5; 
        if(n > 1 && n < maxBuf-1){//累進制
            inccren(c1M,c1M1,c1,n);
            inccren(c2M,c2M1,c2,n);
            inccren(c3M,c3M1,c3max,n);
            inccren(c3M,c3M1,c3min,n);
            //console.log(c1M,c1M1);
        }else if(n == maxBuf-1){
            inccren2(c1M,c1M1,c1,n);
            inccren2(c2M,c2M1,c2,n);
            inccren(c3M,c3M1,c3max,n);
            inccren(c3M,c3M1,c3min,n);
            //console.log(c1M,c1M1);
        }
        
        if(chart1){
            chart1 = false;
            g1 = new Dygraph(document.getElementById('chart1'), cha1,
            {
                drawPoints: true,
                includeZero: false,
                legend: "always",
                labelsDiv: document.getElementById('m1'),
                strokeWidth: 2,
                colors:['darksalmon'],
                labels: ['Time', 'Temp']
            });
        }else{
            var min= n>1 ? c1M[2]-0.25 : c1-0.25;
            var max= n>1 ? c1M[0]+0.25 : c1+0.25;
            //console.log(min,max);
            g1.updateOptions( { 'file': cha1,'valueRange':[min,max]} );
        }
        if(chart2){
            chart2 = false;
            g2 = new Dygraph(document.getElementById('chart2'), cha2,
            {
                drawPoints: true,
                includeZero: false,
                legend: "always",
                labelsDiv: document.getElementById('m2'),
                strokeWidth: 2,
                colors:['darksalmon'],
                labels: ['Time', 'humd']
            });
        }else{
            var min= n>1 ? c2M[2]-0.25 : c2-0.25;
            var max= n>1 ? c2M[0]+0.25 : c2+0.25;
            g2.updateOptions( { 'file': cha2,'valueRange':[min,max]} );
        }
        if(chart3){
            chart3 = false;
            g3 = new Dygraph(document.getElementById('chart3'), cha3,
            {
                drawPoints: true,
                includeZero: false,
                legend: "always",
                labelsDiv: document.getElementById('m3'),
                strokeWidth: 2,
                colors:['darksalmon','darkseagreen','cornflowerblue'],
                labels: ['Time', 'Pm1', 'Pm2.5', 'Pm10']
            });
        }else{
            var min= n>1 ? c3M[2]-0.5 : c3min-0.5;
            var max= n>1 ? c3M[0]+0.5 : c3max+0.5;
            //console.log(min,max);
            g3.updateOptions( { 'file': cha3,'valueRange':[min,max]} );
        }
        plot = true;
}

$( document ).ready(function() {
    var ld = document.getElementById('ld');
    var sv = document.getElementById('sv');
    var a_clk = document.getElementById('a_clk');
    var b_clk = document.getElementById('b_clk');
    var c_clk = document.getElementById('c_clk');
    var d_clk = document.getElementById('d_clk');
        
    $('#c_hid').transition('fade');
    
    ld.onclick = function(){
        ws.send("5,open");
    };
    
    sv.onclick = function(){
        var a0 = document.getElementById('gp').value; 
        var a1 = document.getElementById('gb').value; 
        var a2 = document.getElementById('ap').value; 
        var a3 = document.getElementById('ab').value; 
        var a4 = document.getElementById('dev').value;
        var a5 = document.getElementById('devid').value;
        var a6 = document.getElementById('app').value;
        var a7 = document.getElementById('site').value;
        var a8 = document.getElementById('tlat').value;
        var a9 = document.getElementById('tlon').value;
        var aa = document.getElementById('sp').value;
        ws.send("0,"+a0+","+a1+","+a2+","+a3+","+a4+","+a5+","+a6+","+a7+","+a8+","+a9+","+aa);
    };
    /*
    a_clk.onmouseover  = function(){
        document.body.style.cursor = "pointer";
    };    
    b_clk.onmouseover  = function(){
        document.body.style.cursor = "pointer";
    };    
    c_clk.onmouseover  = function(){
        document.body.style.cursor = "pointer";
    };
    d_clk.onmouseover  = function(){
        document.body.style.cursor = "pointer";
    };
    
    a_clk.onmouseout  = function(){
        document.body.style.cursor = "auto";
    };    
    b_clk.onmouseout  = function(){
        document.body.style.cursor = "auto";
    };    
    c_clk.onmouseout  = function(){
        document.body.style.cursor = "auto";
    };
    d_clk.onmouseout  = function(){
        document.body.style.cursor = "auto";
    };
    */
    $('#a_clk')
    .popup({
        title   : 'Click me,',
        content : 'to hide element.'
    });
    $('#b_clk')
    .popup({
        title   : 'Click me,',
        content : 'to hide element.'
    });
    $('#c_clk')
    .popup({
        title   : 'Click me,',
        content : 'to open map.'
    });
    $('#d_clk')
    .popup({
        title   : 'Click me,',
        content : 'to hide element.'
    });
    
    a_clk.onclick = function(){
        $('#a_hid').transition('horizontal flip');
    };    
    b_clk.onclick = function(){
        $('#b_hid').transition('horizontal flip');
        $('#b_hid2').transition('horizontal flip');
    };    
    c_clk.onclick = function(){
        $('#c_hid').transition('horizontal flip');
    };
    d_clk.onclick = function(){
        $('#d_hid').transition('horizontal flip');
    };
});

var LF=0.8,edT=new Date(),stT=new Date();    
var mab = document.getElementById('mab');
flashLogo = function() {
    requestAnimationFrame(flashLogo);
    edT =new Date();
    if(edT.getTime()-stT.getTime()>100){
        stT=new Date(); 
        rainbow();
    }
    
};
flashLogo();
var led_i=[0,0];
function rainbow(wait) {
  var i, j,maxColor=256;//32;
  i = led_i[0];
  j = led_i[1];
  if(j<maxColor) {
    if(i<1) {
      Wheel((i+j) & (maxColor-1));
      i++;
    }else{
      i=0;
    }
    j++;
  }else{
    j=0;
  }
  led_i[0] = i;
  led_i[1] = j;

}
function Wheel(WheelPos) {
  var maxColor = 255;//31;//255
  var fiColor = 85;//10;//85
  var seColor = 170;//21;//170;
  WheelPos = maxColor - WheelPos;
  if(WheelPos < fiColor) {
    return stripColor(maxColor - WheelPos * 3, 0, WheelPos * 3);
  }
  if(WheelPos < seColor) {
    WheelPos -= fiColor;
    return stripColor(0, WheelPos * 3, maxColor - WheelPos * 3);
  }
  WheelPos -= seColor;
  return stripColor(WheelPos * 3, maxColor - WheelPos * 3, 0);
}
function stripColor( r,  g,  b) {
  mab.style.color="rgba("+r+","+g+","+b+","+LF+")";
}
</script>

</html>
